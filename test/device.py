import serial

from tesmart import utils

# PING
# Request
# 55 01 FE 00 00 00 AB
# Response
# AA 01 FE 00 00 07 41 52 54 2D 30 35 00 D6
#
# CURRENT
# Request
# 55 01 FE 0F 01 06 00 00 00 00 07 A3 EB
# Response
# AA 01 FE 0F 01 07 A3 01 07 12 05 26 02 21 03 01 07 12 26 02 21 CB 46 B9 05 60 12 C0 56 00 00 00 00 00 00 20 00 08 00 00
# 00 00 00 55 91 E9 FF BE C6 FF FF 26 12 D8 02 08 00 0C 00 08 00 20 00 00 00 04 00 00 00 00 00 4A 00 69 00 17 02 17 05 23
# 07 72 00 58 D8 00 00 11 11 00 02 02 04 00 04 00 02 3C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FA 1C 7B 13 FA 09 E0 F8
# 00 80 CF 02 00 00 1B F4 26 13 16 90 1C 00 00 3A 18 ED 18 05 03 9C FF C3 5C 81 F8 2D F8 00 00 00 00 00 C8 C8 5C 00 00 00
# 00 3C 00 00 46 62 00 00 00 00 01 00 00 00 00 00 01 00 D8 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 0F 5F 46 87
# DD 00 00 80 3E 00 00 00 41 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 64 00 54 00 01 00 00 0A 00 05 05 03 01 00 00
# 7C 15 38 FF FF F4 01 01 FF 00 00 00 00 00 FF 00 00 FF 1C 25 01 00 01 00 0C 0A 00 00 00 00 00 00 1E A0 05 00 00 04 00 10
# 0E 00 00 00 00 00 00 00 00 00 00 00 00 0B 03 00 05 0A 00 00 00 00 05 01 00 00 00 00 05 00 00 00 00 00 00 00 00 05 00 00
# 64 3A 18 00 00 00 00 75 14 00 80 00 80 00 80 00 80 00 00 00 00 07 00 80 00 80 00 80 00 00 75 14 70 17 00 04 00 00 78 26
# 81 F8 2D F8 00 00 00 00 5E D0 DA 26 00 00 00 00 3C 00 00 CD FE 00 00 00 00 00 00 00 00 00 00 00 00 4C 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 05 00 14 5F 46 96 E8 00 00 80 3E 00 00 70 42 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 32 00 5A 00 01 00 00 64 00 05 00 04 00 70 17 64 19 00 00 FF F4 01 FF FF 00 00 00 00 00 FF 88 13 FF 00 00 01 00 01 00 0D
# 0A 00 00 00 00 00 00 1E A0 05 00 00 06 00 10 0E 00 00 00 00 00 00 00 00 00 00 00 00 0B 00 00 05 0A 00 00 00 00 05 01 00
# 00 00 00 02 00 00 00 00 00 00 00 00 04 00 00 08 75 14 00 00 00 00 00 09 7F FF 00 19 7F 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 22 22 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 22 0D 41 50 54 2D 20 20 20 57 41 52 4E 49 4E 47 00 1A 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 7E 31
# 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 17 98 BA 39 17 98 BA 39 17 98
# BA 39 17 98 BA 39 17 98 BA 39 17 98 BA 39 17 98 BA 39 17 98 BA 39 06 06 06 06 06 06 06 06 01 03 04 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 F0 C2 00 00
# F0 C2 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 FA 1C 78 13 E0 F8 FA 09 73 14 00 80 00 80
# 00 80 00 D0 00 00 04 00 04 00 04 00 04 00 04 00 00 00 00 00 00 00 E0 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
# 00 00 00 00 00 00 00 00 00 00 00 00 00 64 20 1C 20 1C 00 00 20 1C 20 1C 00 00 00 00 00 00 00 00 00 00 00 00 FF 00 00 FF
# FF FF 94 64 DC 33 69 FF FF FF 10 10 10 10 10 FF FF FF 09 0F 10 03 07 FF FF FF DE DE DE DE DE BB BB BB 44 44 44 44 44 FF
# FF FF 02 FF FF FF C0 83 4C 2A 30 08 83 F0 72 62 FF 01 00 00 00 00 02 18 1E FF 01 00 00 00 00 00 00 00 36 25 20 07 02 18
# 2A FF 18 00 00 00 00 00 00 00 31 49 20 07 02 18 1E FF 01 00 00 00 00 00 00 00 32 49 20 07 02 18 1E FF 01 00 00 00 00 00
# 00 00 DB


PING_RESPONSE_BODY = '41 52 54 2D 30 35 00'
CURRENT_RESPONSE_BODY = (
    '01 07 12 05 26 02 21 03 01 07 12 26 02 21 CB 46 B9 05 60 12 C0 56 00 00 00 00 00 00 20 00 08 '
    '00 00 00 00 00 55 91 E9 FF BE C6 FF FF 26 12 D8 02 08 00 0C 00 08 00 20 00 00 00 04 00 00 00 '
    '00 00 4A 00 69 00 17 02 17 05 23 07 72 00 58 D8 00 00 11 11 00 02 02 04 00 04 00 02 3C 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 FA 1C 7B 13 FA 09 E0 F8 00 80 CF 02 00 00 1B F4 26 13 16 '
    '90 1C 00 00 3A 18 ED 18 05 03 9C FF C3 5C 81 F8 2D F8 00 00 00 00 00 C8 C8 5C 00 00 00 00 3C '
    '00 00 46 62 00 00 00 00 01 00 00 00 00 00 01 00 D8 09 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 02 00 0F 5F 46 87 DD 00 00 80 3E 00 00 00 41 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 64 00 54 00 01 00 00 0A 00 05 05 03 01 00 00 7C 15 38 FF FF F4 01 01 FF 00 00 00 00 00 FF '
    '00 00 FF 1C 25 01 00 01 00 0C 0A 00 00 00 00 00 00 1E A0 05 00 00 04 00 10 0E 00 00 00 00 00 '
    '00 00 00 00 00 00 00 0B 03 00 05 0A 00 00 00 00 05 01 00 00 00 00 05 00 00 00 00 00 00 00 00 '
    '05 00 00 64 3A 18 00 00 00 00 75 14 00 80 00 80 00 80 00 80 00 00 00 00 07 00 80 00 80 00 80 '
    '00 00 75 14 70 17 00 04 00 00 78 26 81 F8 2D F8 00 00 00 00 5E D0 DA 26 00 00 00 00 3C 00 00 '
    'CD FE 00 00 00 00 00 00 00 00 00 00 00 00 4C 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 05 '
    '00 14 5F 46 96 E8 00 00 80 3E 00 00 70 42 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 32 '
    '00 5A 00 01 00 00 64 00 05 00 04 00 70 17 64 19 00 00 FF F4 01 FF FF 00 00 00 00 00 FF 88 13 '
    'FF 00 00 01 00 01 00 0D 0A 00 00 00 00 00 00 1E A0 05 00 00 06 00 10 0E 00 00 00 00 00 00 00 '
    '00 00 00 00 00 0B 00 00 05 0A 00 00 00 00 05 01 00 00 00 00 02 00 00 00 00 00 00 00 00 04 00 '
    '00 08 75 14 00 00 00 00 00 09 7F FF 00 19 7F 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 22 22 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 22 0D 41 50 54 2D 20 20 20 57 41 '
    '52 4E 49 4E 47 00 1A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 00 00 7E 31 '
    '00 00 7E 31 00 00 17 98 BA 39 17 98 BA 39 17 98 BA 39 17 98 BA 39 17 98 BA 39 17 98 BA 39 17 '
    '98 BA 39 17 98 BA 39 06 06 06 06 06 06 06 06 01 03 04 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 '
    '00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 00 00 F0 C2 FA 1C 78 13 E0 F8 FA 09 73 14 00 80 00 80 00 '
    '80 00 D0 00 00 04 00 04 00 04 00 04 00 04 00 00 00 00 00 00 00 E0 00 01 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 '
    '00 00 00 00 00 00 00 00 64 20 1C 20 1C 00 00 20 1C 20 1C 00 00 00 00 00 00 00 00 00 00 00 00 '
    'FF 00 00 FF FF FF 94 64 DC 33 69 FF FF FF 10 10 10 10 10 FF FF FF 09 0F 10 03 07 FF FF FF DE '
    'DE DE DE DE BB BB BB 44 44 44 44 44 FF FF FF 02 FF FF FF C0 83 4C 2A 30 08 83 F0 72 62 FF 01 '
    '00 00 00 00 02 18 1E FF 01 00 00 00 00 00 00 00 36 25 20 07 02 18 2A FF 18 00 00 00 00 00 00 '
    '00 31 49 20 07 02 18 1E FF 01 00 00 00 00 00 00 00 32 49 20 07 02 18 1E FF 01 00 00 00 00 00 '
    '00 00 '
)


def response_packet(cmd_group: int, cmd: int, command: str) -> bytearray:
    packet = bytearray()
    packet.extend(bytes.fromhex('AA'))
    packet.extend(utils.slave_bytes(1))
    packet.extend(bytes([cmd_group, cmd]))
    body = bytearray.fromhex(command)
    packet.extend(utils.int_to_bytes(len(body)))
    packet.extend(body)
    packet.extend(utils.calc_checksum(packet))
    return packet


def run_mock_device(port: str) -> None:
    while True:
        while True:
            with serial.Serial(port, timeout=3) as ser:
                result: bytearray = bytearray(ser.readline())
                if result:
                    is_valid = utils.validate_response(result)
                    if is_valid:
                        cmd_group, cmd = result[3], result[4]
                        if cmd_group == 0 and cmd == 0:
                            packet = response_packet(cmd_group, cmd, PING_RESPONSE_BODY)
                            ser.write(packet)
                            break
                        if cmd_group == 15 and cmd == 1:
                            packet = response_packet(cmd_group, cmd, CURRENT_RESPONSE_BODY)
                            print(len(packet), packet)
                            ser.write(packet)
                            break
                        response = utils.format_bytestring(result[6:-1])
                        print(response)
                    break
